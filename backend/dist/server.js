import "./config/env.js";
import express from "express";
import cors from "cors";
import cookieParser from "cookie-parser";
import connectDB from "./config/db.js";
import authRoutes from "./routes/auth.js";
import spotifyUserRoutes from "./routes/spotify-user.js";
import spotifyPlaylistRoutes from "./routes/spotify-playlists.js";
import aiRoutes from "./routes/ai.js";
const app = express();
const frontendOrigin = process.env.FRONTEND_URL ?? process.env.FRONTEND_ORIGIN ?? "http://localhost:5173";
const allowedOrigins = frontendOrigin.split(",").map((o) => o.trim()).filter(Boolean);
// Use a dynamic origin validator to reliably reflect the request origin
// when it's allowed. This is more explicit and avoids edge cases with
// origin arrays in some environments.
// In development, ensure Access-Control-Allow-Origin is always present
// for browser requests. This middleware runs before the `cors` package
// so preflight responses generated by `cors` will include the header.
if (process.env.NODE_ENV === 'development') {
    app.use((req, res, next) => {
        const origin = req.headers.origin;
        if (origin) {
            res.setHeader('Access-Control-Allow-Origin', origin);
            res.setHeader('Access-Control-Allow-Credentials', 'true');
        }
        next();
    });
}
app.use(cors({
    origin: (origin, callback) => {
        // Allow non-browser tools (no origin) and development mode
        if (!origin || process.env.NODE_ENV === 'development') {
            callback(null, true);
            return;
        }
        if (allowedOrigins.includes(origin)) {
            callback(null, true);
            return;
        }
        callback(new Error(`Origin ${origin} not allowed by CORS`));
    },
    credentials: true,
}));
app.use(express.json());
app.use(cookieParser());
connectDB();
app.use("/api/auth", authRoutes);
app.use("/api/spotify", spotifyUserRoutes);
app.use("/api/spotify/playlists", spotifyPlaylistRoutes);
app.use("/api/ai", aiRoutes);
const PORT = process.env.PORT ?? 5001;
app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
//# sourceMappingURL=server.js.map